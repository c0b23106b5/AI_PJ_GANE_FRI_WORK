# 開発説明書 / Development Guide

このドキュメントは、デジタル版「廃墟からの脱出」を開発・保守するための指針をまとめたものです。ゲーム仕様の詳細は `README.md` と `game_rule_doc.md` を参照し、本書では実装面の流れや作業手順、運用ルールを整理しています。

---

## 1. プロジェクト概要

| 項目 | 内容 |
| ---- | ---- |
| 言語 / 実行環境 | Python 3.11 以上（外部依存なし） |
| 実行方法 | `python src/main.py [seed]` |
| テスト | `python -m unittest discover -v` |
| 主なディレクトリ | `src/haikyo_escape/`（ゲーム本体）、`tests/`（単体テスト） |

ゲームはターン制で進行し、プレイヤーフェーズ → 幽霊フェーズ → 勝敗判定を `GameEngine` が統括します。CLI 入力、状態更新、ログ記録などは `GameState` と各モジュールが分担しています。

---

## 2. ディレクトリと責務

| パス | 役割 |
| ---- | ---- |
| `src/main.py` | CLI エントリポイント。初期化とメインループの起動のみ担当。 |
| `src/haikyo_escape/engine.py` | プレイヤー行動と幽霊行動を順番に処理するゲームエンジン。 |
| `src/haikyo_escape/state.py` | 盤面状態・ログ・判定処理を集中管理する中核モジュール。 |
| `src/haikyo_escape/dungeon.py` | 9部屋構成のダンジョン生成とアイテム配置。 |
| `src/haikyo_escape/room.py` | 部屋（6×6 グリッド）とドア・壁のデータ構造。 |
| `src/haikyo_escape/entities.py` | プレイヤー、幽霊、アイテムに関するデータクラスとユーティリティ。 |
| `src/haikyo_escape/types.py` | 方向・座標などの共通型。 |
| `tests/test_state.py` | `GameState` 周辺の単体テスト。将来的にはテストを拡張予定。 |

---

## 3. ターン進行の流れ

1. `GameEngine.run_turn()`  
   - ターンカウンタを増加させ、`GameState.tick_start_of_turn()` を呼び出す。  
   - CLI コールバックから入力を受け取り `_resolve_player_action()` へ渡す。
2. プレイヤー行動 (`move/search/take/use/wait/quit` など)  
   - アクションの成否に応じて `GameState` 内の状態やログを更新。  
   - 行動が消費された場合は幽霊スポーン判定 (`_maybe_spawn_ghosts`) を実行。
3. 勝敗判定（プレイヤー側）  
   - `GameState.check_victory()` が鍵／出口到達や幽霊接触を確認。
4. 幽霊フェーズ  
   - `_move_ghosts()` が各幽霊の移動距離を決定し、`GameState.move_ghost_towards_player()` で追跡。
5. 勝敗判定（幽霊側）  
   - 再度 `check_victory()` を実行し、終了条件を確認。

---

## 4. 開発フローとチェックリスト

### 4-1. 新機能を追加するとき
1. **仕様の確認**  
   - ゲームルールと README を更新し、画面やログに必要な文言を洗い出す。
2. **状態・データ構造の設計**  
   - `GameState` に新しいカウンタやフラグを追加する場合は、初期化・リセット・ログの扱いを忘れない。  
   - 新規アイテム／効果は `ItemType` と `entities.py` に追記し、扱い方を `engine.py`（利用側）または `state.py`（状態側）に実装。
3. **ダンジョンや部屋の変更**  
   - `dungeon.py` で壁／探索マス／アイテムテーブルを調整。  
   - 脆い壁など特殊タイルを導入するときは `room.py` に専用のメソッドとフラグを追加。
4. **ログ・メッセージ**  
   - すべて日本語で記述し、利用者が状況を追えるようにする。  
   - 既存ログとのトーンを揃える。
5. **テスト**  
   - 既存の `tests/test_state.py` を参考に、再現性のあるシナリオを追加。  
   - 新しい判定や効果を導入した場合は、その成功／失敗を検証するテストを必須とする。
6. **最終確認**  
   - `python -m unittest discover -v` を実行。  
   - `README.md` / `game_rule_doc.md` / 本ガイドに必要な追記が反映されているか確認する。

### 4-2. 既存コードを改修するとき
- 変更箇所の責務を再確認し、関心事が分離されているかをチェック。  
- ログやデータ構造を変えた場合は互換性への影響（過去ログの読みやすさ、テストの更新など）を確認。  
- 変数名やフラグを追加したら `reset()` や `__post_init__()` の初期化漏れがないかを調べる。

---

## 5. コーディング規約（抜粋）

- **言語**: 変数名・ログ・コメントは基本的に日本語。ただし Python の API 仕様や一般的な表現は英語でも可。  
- **型ヒント**: 既存コードに倣い、すべての公開メソッド・関数に型ヒントを付与。  
- **ログの書き方**: `GameState.record()` を利用し、状態変化が追跡できるようにする。  
- **docstring / コメント**: 日本語で簡潔に。冗長な説明は README か本書へ移動する。  
- **PEP 8**: インデント 4 スペース、行末スペース禁止、80〜100 文字以内を目安にする。  
- **TODO**: 未実装の要件は `# TODO:` で残し、次の開発者が状況を把握できるよう日本語で補足する。

---

## 6. テスト戦略

1. **ユニットテスト**  
   - `tests/test_state.py` に `GameState` の振る舞いを追加。  
   - 例: 「特定アイテムを拾うと速度が上がる」「脆い壁が破壊される」など。
2. **シナリオテスト（将来拡張）**  
   - CLI 入力をシミュレーションする関数を追加し、複数ターンにわたるシナリオをテストすることを検討。  
   - 出力ログの安定性が課題になるため、リファクタリングやログ整形の改善が整ってから導入予定。
3. **手動テスト**  
   - `python src/main.py <seed>` で再現性のある状況を再現し、ログの見やすさやゲームバランスを確認する。

---

## 7. 開発のヒント

- **アイテム追加のテンプレート**  
  1. `ItemType` に新しい列挙値を追加。  
  2. `entities.py`（プレイヤーや幽霊の所持管理）に必要なフィールドを追加。  
  3. `dungeon.py` の `item_templates` にエントリを追加し、探索マスに配置されるようにする。  
  4. `GameEngine._handle_use()` か `GameState` の適切な場所で効果を実装。  
  5. テストケースを作成し、効果が想定通り発動するか検証。

- **幽霊 AI の拡張**  
  - 移動距離や経路選択のアルゴリズムは `engine.py` と `state.py` に集約。  
  - 新しい戦略を導入する場合、`Ghost` クラスに設定値を持たせ、`GameEngine` 側で切り替えられるようにする。

- **マップ改修**  
  - `dungeon.py` のレイアウトが単純なため、将来的に JSON や外部ファイル化する余地がある。  
  - 現状は Python コード内で壁・探索マスを定義しているため、変更時は可読性を優先しコメントを追加する。

---

## 8. ドキュメント更新のルール

- ゲーム仕様の変更は **必ず** `README.md` と `game_rule_doc.md` を更新。  
- 実装指針や新しい開発手順が増えた場合はこの `DEV_GUIDE.md` に追記。  
- 変更を行ったメンバーと担当箇所は、コミットメッセージや Pull Request に明記する。

---

## 9. 今後の TODO（例）

1. 自動シミュレーター（複数シードで統計を取るスクリプト）の導入。  
2. 幽霊の挙動バリエーション（巡回・索敵・聞き耳など）の追加。  
3. GUI 版実装を見越した入力抽象化（コマンドオブジェクト化）。  
4. テスト範囲の拡大（凍結解除のタイミング、ドア施錠・解錠、加速効果のリセットなど）。

---

## 10. 連絡先 / チーム情報

- C0B23159 チンジュンミン  
- C0B23145 山本真之介  
- C0B23106 中島聖成  
- C0B23085 新宮 尊

疑問点や設計変更の提案がある場合は、上記メンバー間で共有し、仕様・実装の同期を取ってから作業を進めてください。
